<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/default}">

<head>
<title>구성비 조회</title>

</head>
<div layout:fragment="content">
	<div class="card mb-3">
		<div class="card-body ">
				<div class="row gx-2">
					<div class="col-sm-3 mb-3">
						<select id="projectNameItemDropdown" class="form-select picker" data-live-search="true">
                      	<option value="">프로젝트 선택</option>
                      </select>
					</div>
					<div class="col-sm-3 mb-3 ">
						<select id="regdtimDropdown" class="form-select picker" data-live-search="true">
                      		<option value="">수행일시 선택</option>
                      	</select>
					</div>
					<div class="col-sm-3 mb-3">
						<select id="fieldNameDropdown" class="form-select picker" data-live-search="true">
                      		<option value="">항목 선택</option>
                      	</select>
					</div>
					<div class="col-sm-3 mb-3">
						<button class="btn btn-primary" type="button" id="goFileMonitoring">파일모니터링</button>
					</div>
				</div>
			</div>      
	</div>
	<div class="card mb-3">
		<div class="card-body">
			<div class="tab-pane preview-tab-pane active" role="tabpanel"
					aria-labelledby="tab-dom-28a0c0e7-4d81-45ea-b108-f94c2e55ef9c"
					id="dom-28a0c0e7-4d81-45ea-b108-f94c2e55ef9c">
					<table
						class="table table-sm table-striped fs--1 mb-0 overflow-hidden"
						id="table">
					</table>
				</div>
		</div>
	</div>

	<script type="text/javascript">
		var $table = $('#table');
		var $projectNameItemDropdown = $("#projectNameItemDropdown");
		var $regdtItemDropdown = $("#regdtimDropdown");
		var $fieldNameDropdown = $("#fieldNameDropdown");
		
		var target_memberId = null;
		
		$(function() {
			
			fn_projectNames();
			fn_Table();
			fn_Event();
		});
		

		function fn_projectNames() {
			var param = {
					 target : "PROJECT_NAMES",
					 url : "/resultitemdist/projectnames/",
					 isLoading: false
				}
	    	ajaxCall(param);
		}
		
		function fn_regdtItems(projectName) {
			var param = {
					 target : "REGDT_ITEMS",
					 url : "/resultitemdist/" + projectName + "/regdtim/",
					 isLoading: false
				}
	    	ajaxCall(param);
		}
		
		function fn_fieldItems(projectName, regdtim) {
			var param = {
					 target : "FIELDNAME_ITEMS",
					 url : "/resultitemdist/fieldname/" + projectName + "/" + regdtim,
					 isLoading: false
				}
	    	ajaxCall(param);
		}

		

		function fn_Event() {

		}
		
		
		function fn_Table() {
			$table.bootstrapTable('destroy').bootstrapTable(
					{
						theadClasses:'bg-200 text-900',
						height : 650,
						pageSize : "20",
						pageList : "[5, 10, 20, 50, all]",
						columns : [
								{
					              title: '항목코드',
					              field: 'fieldName',
					              align: 'center',
					              sortable: true,
					              valign: 'middle'
					            }, {
					                title: '항목 값',
					                field: 'itemValue',
					                align: 'center',
					                sortable: true,
					                valign: 'middle'
					            }, {
					              title: '개발시점 분포(%)',
					              field: 'devProbability',
					              align: 'right',
					              sortable: true,
					              valign: 'middle'
					            }, {
					              title: '선택시점 분포(%)',
					              field: 'nowProbability',
					              align: 'right',
					              sortable: true,
					              valign: 'middle'
					            }, {
					                title: '분포 차이(%)',
					                field: 'diff',
					                align: 'right',
					                sortable: true,
					                valign: 'middle'
					            }],
						onClickRow : function(row, $element, field) {}
					});
			tableRefresh();
		}
		
		
		function tableRefresh(){
			const projectName = $projectNameItemDropdown.val();
        	const regdtim = $regdtItemDropdown.val();
			const fieldNameDropdown = $fieldNameDropdown.val();
        	if(projectName && regdtim) {
        		bootstrapTableRefresh($table, '/resultitemdist/'+projectName+'/'+regdtim+'/'+fieldNameDropdown ,
    					'[[${#locale}]]', '[[#{table.data.faile}]]');	
        	}
		}
		
		
		function responseHandler(res) {
			$.each(res, function(i) {
				this.index = i + 1;
			});
			return res;
		}
		
		
		function callback(target, data) {
			
			switch (target) {
			case "PROJECT_NAMES":
				var listName = data;
				var html = "";
				
                $.each(listName, function(index, data) {
                	html += "<option value="+data+">"+data+"</option>";
                });
                $projectNameItemDropdown.append(html);
                $projectNameItemDropdown.off();
                $projectNameItemDropdown.change(function(){
                	if($(this).val()) fn_regdtItems($(this).val());
                });

    			$('.picker').select2();
				break;
				
			case "REGDT_ITEMS":
				$regdtItemDropdown.find("option").remove();
				var html = "<option value=''>수행일시 선택</option>";
				
                $.each(data, function(index, data) {
                	html += '<option value="'+data+'">'+data+'</option>';
                });
                $regdtItemDropdown.append(html);
                
                $regdtItemDropdown.off();
                $regdtItemDropdown.change(function(){
                	fn_fieldItems($projectNameItemDropdown.val(), $regdtItemDropdown.val());
                	tableRefresh();
                });
                $('.picker').select2();
				break;
			case "FIELDNAME_ITEMS":
				$fieldNameDropdown.find("option").remove();
				var html = "<option value=''>항목 선택</option>";
				
                $.each(data, function(index, data) {
                	html += '<option value="'+data+'">'+data+'</option>';
                });
                $fieldNameDropdown.append(html);
                
                $fieldNameDropdown.off();
                $fieldNameDropdown.change(function(){
                	tableRefresh();
                });
                $('.picker').select2();
				break;
			    
			default:
				break;
			}
		}
		
		

	</script>

</div>
</html>