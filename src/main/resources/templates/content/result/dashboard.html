<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/default}">

<head>
<title>[[#{txt.title.dashboard}]]</title>
</head>
<div layout:fragment="content">
	<div class="card mb-3">
		<div class="bg-holder d-none d-lg-block bg-card"
			style="background-image: url(/assets/img/illustrations/corner-4.png);">
		</div>
		<div class="card-body">
			<div class="row flex-between-center">
				<div class="col-sm-auto mb-2 mb-sm-0">
					<h6 class="mb-0">[[#{txt.recent.time}]] <span class="text-500" id="recentDtim"></span></h6>
				</div>
				<div class="col-sm-auto">
					<div class="row gx-2 align-items-center">
						<div class="col-auto">
							<select id="projectNameItemDropdown" class="form-select picker"
								data-live-search="true">
								<option value="">[[#{select.project.select}]]</option>
							</select>
						</div>
						<div class="col-auto">
							<select id="countDropdown" class="form-select picker"
								data-live-search="true">
								<!-- <option value="">[[#{select.perform.select}]]</option>
								<option value="7">[[#{select.perform.select.001}]]</option>
								<option value="15">[[#{select.perform.select.001}]]</option>
								<option value="30">[[#{select.perform.select.001}]]</option> -->

								<option value="all">[[#{select.perform.select}]]</option>
								<option value="oneday">[[#{select.perform.select.001}]]</option>
								<option value="oneweek">[[#{select.perform.select.002}]]</option>
								<option value="onemonth">[[#{select.perform.select.003}]]</option>
								<option value="onequarter">[[#{select.perform.select.004}]]</option>
								<option value="onehalf">[[#{select.perform.select.005}]]</option>
								<option value="oneyear">[[#{select.perform.select.006}]]</option>
							</select>
						</div>
						<div class="col-auto pe-0">
							<div class="input-group">
								<div class="input-group-append">
									<button type="button" id="goReport" class="btn btn-primary" disabled>[[#{button.report}]]</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="row g-3 mb-3">
		<div class="col-lg-6">
			<div class="card">
				<div class="card-header">
					<div class="row flex-between-end">
						<div class="col-auto col-lg align-self-center">
							<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
								<a class="anchorjs-link " aria-label="Anchor"
									data-anchorjs-icon="#" href="#bar-chart"
									style="padding-left: 0.375em;">[[#{txt.distribution.stability.indicator}]]</a>
							</h5>
						</div>
					</div>
				</div>
				<div class="card-body bg-light">
					<div class="tab-content">
						<div id="psiChart" style="min-height: 250px;"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-6">
			<div class="card">
				<div class="card-header">
					<div class="row flex-between-end">
						<div class="col-auto col-lg align-self-center">
							<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
								<a class="anchorjs-link " aria-label="Anchor"
									data-anchorjs-icon="#" href="#bar-chart"
									style="padding-left: 0.375em;">[[#{txt.data.count}]]</a>
							</h5>
						</div>
					</div>
				</div>
				<div class="card-body bg-light">
					<div class="tab-content">
						<div id="dataCntChart" style="min-height: 250px;"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="row g-3 mb-3">
		<div class="col-lg-6">
			<div class="card">
				<div class="card-header">
					<div class="row flex-between-end">
						<div class="col-auto col-lg align-self-center">
							<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
								<a class="anchorjs-link " aria-label="Anchor"
									data-anchorjs-icon="#" href="#bar-chart"
									style="padding-left: 0.375em;">[[#{txt.anomaly.count}]]</a>
							</h5>
						</div>
					</div>
				</div>
				<div class="card-body bg-light">
					<div class="tab-content">
						<div id="dashItemBar" style="min-height: 250px;"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-6">
			<div class="card">
				<div class="card-header">
					<div class="row flex-between-end">
						<div class="col-auto col-lg align-self-center">
							<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
								<a class="anchorjs-link " aria-label="Anchor"
									data-anchorjs-icon="#" href="#bar-chart"
									style="padding-left: 0.375em;">[[#{txt.distribution.anomaly.count}]]</a>
							</h5>
						</div>
					</div>
				</div>
				<div class="card-body bg-light">
					<div class="tab-content">
						<div id="dashChisqBar" style="min-height: 250px;"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		var $projectNameItemDropdown = $("#projectNameItemDropdown");
		var $countDropdown = $("#countDropdown");
		var $report = $("#goReport");
		var projectName = "";
		var recentPeriod = "all";

		$(function() {
			fn_projectNames();
			fn_Event();
		
			// boxplot sample
			var boxplotParam = {}			
			var boxplotData = [];
			var data0 = [
	            [50, 40, -90, -170, -90, 50, -90, -90, 80, -80, -100, 90, 93, 65, 76, -810, -100, -1000, -90, 90],
	            [960, 940, 960, 940, 880, 800, 850, 880, 900, 840, 830, 790, 810, 880, 880, 830, 800, 790, 760, 800],
	            [880, 880, 880, 860, 720, 720, 620, 860, 970, 950, 880, 910, 850, 870, 840, 840, 850, 840, 840, 840]
	           
	        ]
			var data1 =[
	            [890, 810, 810, 820, 800, 770, 760, 740, 750, 760, 910, 920, 890, 860, 880, 720, 840, 850, 850, 780],
	            [890, 810, 810, 820, 800, 770, 760, 740, 750, 760, 910, 920, 890, 860, 880, 720, 840, 850, 850, 780],
	            [890, 840, 780, 810, 760, 810, 790, 810, 820, 850, 870, 870, 810, 740, 810, 940, 950, 800, 810, 870]
	        ]
			var data2 = [
				[960, 940, 960, 940, 880, 800, 850, 880, 900, 840, 830, 790, 810, 880, 880, 830, 800, 790, 760, 800],
	            [890, 840, 780, 810, 760, 810, 790, 810, 820, 850, 870, 870, 810, 740, 810, 940, 950, 800, 810, 870],
	            [890, 840, 780, 810, 760, 810, 790, 810, 820, 850, 870, 870, 810, 740, 810, 940, 950, 800, 810, 870]
	        ]
						
			boxplotData.push(data0)
			boxplotData.push(data1)
			boxplotData.push(data2)
			boxplotParam.data = boxplotData
			boxplotParam.title = "테스트"
			boxplotParam.name = ["테스트1", "테스트2", "테스트3"]			
			boxplotParam.yAxisNm = "크기"			
			// boxplotModal(boxplotParam)
			// boxplot sample
			
		});

		function fn_Event() {
			$countDropdown.off().on('change', function() {
				recentPeriod = $(this).val();
				fn_data();
			});
			$report.off().on('click', function() {
				var param = {
						projectName : projectName,
						recentPeriod : recentPeriod
				}
				
				$("#paramForm").prop('action','/result/dataReport');
				$("#paramData").val(JSON.stringify(param));
				$("#paramForm").submit(); 
			});
		}

		function fn_projectNames() {
			ajaxCall({
				target : "PROJECT_NAMES",
				url : "/result/projectnames/",
				isLoading : false
			});
		}

		function fn_data() {
			ajaxCall({
				target : "RECENTDTIM",
				url : "/main/regdtim/" + projectName,
				isLoading : false
			});
		}

		function callback(target, data) {
			switch (target) {
			case "PROJECT_NAMES":
				var listName = data;
				var html = "";

				$.each(listName, function(index, data) {
					html += "<option value="+data+">" + data + "</option>";
				});
				$projectNameItemDropdown.append(html);
				$projectNameItemDropdown.off().on(
						'change',
						function() {
							projectName = $(this).val();
							
							gf_IsNull(projectName)							
								? $report.prop('disabled',true)
								: $report.prop('disabled', false);

							fn_data();
						});
				$('.picker').select2();

				fn_data();

				break;
			case "RECENTDTIM":
				$("#recentDtim").html(data[0]);

				ajaxCall({
					target : "STAT",
					url : "/main/stat/" + projectName + "/" + recentPeriod
				});
				break;
			case "STAT":
				var statData = {
					"dtims" : [],
					"psis" : [],
					"cars" : [],
					"chisqcnts" : [],
					"datacnts" : []
				};
				$.each(data, function() {
					statData.dtims.push(this.dtim);
					statData.psis.push(parseFloat(this.psi));
					statData.cars.push(parseInt(this.car));
					statData.chisqcnts.push(parseInt(this.chisqcnt));
					statData.datacnts.push(parseInt(this.inputDataCnt));
				});
				fn_LineChart(statData); // 분포 안정 지표

				// 데이터 수 
				var param = {
					target : "dataCntChart",
					title : '[[#{txt.data.count}]]',
					xData : statData.dtims,
					yData : statData.datacnts,
					name : '[[#{txt.number.count}]]',
					barColor : utils.getColors().primary,

				}
				fn_BarChart(param)

				// 일별 이상항목수 
				param.target = "dashItemBar";
				param.title = '[[#{txt.anomaly.count}]]';
				param.xData = statData.dtims;
				param.yData = statData.cars;
				param.name = '[[#{txt.item.count}]]';
				param.barColor = utils.getColors().danger
				fn_BarChart(param)

				// 분포 이상 항목수				
				param.target = "dashChisqBar";
				param.title = '[[#{txt.distribution.anomaly.count}]]';
				param.xData = statData.dtims;
				param.yData = statData.chisqcnts;
				param.barColor = utils.getColors().primary;
				fn_BarChart(param);

				break;
			default:
				break;
			}
		}

		function fn_LineChart(data) {
			if (psiLineChart != null) {
				psiLineChart.destroy();
			}

			var dataSize = data.dtims.length
			var thresholdValue = 1.0;
			var thresholdArray = new Array(dataSize);
			for (var i = 0; i < dataSize; i++) {
				thresholdArray[i] = thresholdValue;
			}

			var psiLineChart = document.getElementById('psiChart');
			var myChart = echarts.init(psiLineChart);
			var option;

			option = {
				title : {
					text : '[[#{txt.distribution.stability.indicator}]]',
					show : false
				},
				color : [ utils.getColors().primary, utils.getColors().danger ],
				tooltip : {
					trigger : 'axis',
					padding : [ 7, 10 ],
					backgroundColor : utils.getGrays()['100'],
					borderColor : utils.getGrays()['300'],
					textStyle : {
						color : utils.getColors().dark
					},
					borderWidth : 1,
					transitionDuration : 0,
					position : function position(pos, params, dom, rect, size) {
						return getPosition(pos, params, dom, rect, size);
					}
				},

				legend : {
					data : [ 'PSI', 'Threshold' ],
					left : 'center',
					itemWidth : 10,
					itemHeight : 10,
					borderRadius : 0,
					icon : 'circle',
					inactiveColor : utils.getGrays()['400'],
					textStyle : {
						color : utils.getGrays()['700']
					}
				},

				toolbox : {
					feature : {
						saveAsImage : {
							title : 'Save As'
						}
					}
				},
				xAxis : {
					type : 'category',
					data : data.dtims,
					boundaryGap : false,
					axisPointer : {
						lineStyle : {
							color : utils.getGrays()['300'],
							type : 'dashed'
						}
					},
					splitLine : {
						show : false
					},
					axisLine : {
						lineStyle : {
							color : utils.rgbaColor('#000', 0.01),
							type : 'dashed'
						}
					},
					axisTick : {
						show : false
					},
					axisLabel : {
						color : utils.getGrays()['400'],
						margin : 15,
						rotate : 45,
						textStyle : {
							fontSize : 10
						}
					}
				},
				yAxis : {
					type : 'value',
					axisPointer : {
						show : false
					},
					splitLine : {
						lineStyle : {
							color : utils.getGrays()['300'],
							type : 'dashed'
						}
					},
					boundaryGap : false,
					axisLabel : {
						show : true,
						color : utils.getGrays()['400'],
						margin : 15,
						textStyle : {
							fontSize : 10
						}
					},
					axisTick : {
						show : false
					},
					axisLine : {
						show : false
					}
				},
				series : [
						{
							name : 'PSI',
							type : 'line',
							data : data.psis,
							lineStyle : {
								color : utils.getColors().primary
							},
							itemStyle : {
								borderColor : utils.getColors().primary,
								borderWidth : 2
							},
							showSymbol : false,
							smooth : true,
							hoverAnimation : true,
							areaStyle : {
								color : {
									type : 'linear',
									x : 0,
									y : 0,
									x2 : 0,
									y2 : 1,
									colorStops : [
											{
												offset : 0,
												color : utils.rgbaColor(utils
														.getColors().primary,
														0.2)
											},
											{
												offset : 1,
												color : utils
														.rgbaColor(
																utils
																		.getColors().primary,
																0)
											} ]
								}
							}
						}, {
							name : 'Threshold',
							type : 'line',
							data : thresholdArray,
							lineStyle : {
								color : utils.getColors().danger
							},
							itemStyle : {
								borderColor : utils.getColors().danger,
								borderWidth : 2
							},
							showSymbol : false,
							smooth : false,
							hoverAnimation : true
						}

				]
			};

			option && myChart.setOption(option);
		}

		function fn_BarChart(param) {

			if (itemBarChart != null) {
				itemBarChart.destroy();
			}

			var itemBarChart = document.getElementById(param.target);
			var myChart = echarts.init(itemBarChart);
			var option;

			option = {
				title : {
					text : param.title,
					show : false
				},
				color : [ utils.getColors().primary ],
				tooltip : {
					trigger : 'item',
					padding : [ 7, 10 ],
					backgroundColor : utils.getGrays()['100'],
					borderColor : utils.getGrays()['300'],
					textStyle : {
						color : utils.getColors().dark
					},
					borderWidth : 1,
					transitionDuration : 0,
					position : function position(pos, params, dom, rect, size) {
						return getPosition(pos, params, dom, rect, size);
					}
				},

				legend : {
					data : [ param.name ],
					left : 'center',
					itemWidth : 10,
					itemHeight : 10,
					borderRadius : 0,
					icon : 'circle',
					inactiveColor : utils.getGrays()['400'],
					textStyle : {
						color : utils.getGrays()['700']
					}
				},
				toolbox : {
					feature : {
						saveAsImage : {
							title : 'Save As'
						}
					}
				},
				xAxis : {
					type : 'category',
					data : param.xData,
					axisLabel : {
						color : utils.getGrays()['400'],
						rotate : 45,
						textStyle : {
							fontSize : 10
						}
					},
					axisLine : {
						lineStyle : {
							color : utils.getGrays()['300'],
							type : 'dashed'
						}
					},
					axisTick : false,
					boundaryGap : true

				},
				yAxis : {
					axisPointer : {
						type : 'none'
					},
					axisTick : 'none',
					splitLine : {
						lineStyle : {
							color : utils.getGrays()['300'],
							type : 'dashed'
						}
					},
					axisLine : {
						show : false
					},
					axisLabel : {
						color : utils.getGrays()['400'],
						rotate : 45,
						textStyle : {
							fontSize : 10
						}
					}
				},
				series : [ {
					name : param.name,
					type : 'bar',
					data : param.yData,
					type : 'bar',
					barWidth : '12%',
					barGap : '30%',
					label : {
						normal : {
							show : false
						}
					},
					z : 10,
					itemStyle : {
						normal : {
							barBorderRadius : [ 10, 10, 0, 0 ],
							color : param.barColor
						}
					}
				}, {
					type : 'bar',
					barWidth : '12%',
					barGap : '30%',
					label : {
						normal : {
							show : false
						}
					},
					itemStyle : {
						normal : {
							barBorderRadius : [ 4, 4, 0, 0 ],
							color : utils.getGrays()[300]
						}
					}
				} ],
			};

			option && myChart.setOption(option);
		}
	</script>
</div>
</html>