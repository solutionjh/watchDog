<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate ="~{layout/default}">
	
<head>
<title>데이터 검증 보고서</title>
</head>
	<div layout:fragment="content">
	<div class="card mb-3">
		<div class="bg-holder d-none d-lg-block bg-card"
			style="background-image: url(/assets/img/illustrations/corner-4.png);">
		</div>
		<div class="card-body">
			<div class="row flex-between-center">
				<div class="col-sm-auto mb-2 mb-sm-0">
					<h6 class="mb-0">최근실행시간 : <span class="text-500" id="recentDtim"></span></h6>
				</div>
				<div class="col-sm-auto">
					<div class="row gx-2 align-items-center">
						<div class="col-auto">
							<select id="projectNameItemDropdown" class="form-select picker"
								data-live-search="true">
								<option value="">프로젝트 선택</option>
							</select>
						</div>
						<div class="col-auto">
							<select id="countDropdown" class="form-select picker"
								data-live-search="true">
								<!-- <option value="">수행일시 선택</option>
								<option value="7">직전 7건</option>
								<option value="15">직전 15건</option>
								<option value="30">직전 30건</option> -->

								<option value="all">수행일시 선택</option>
								<option value="oneday">최근 1일</option>
								<option value="oneweek">최근 1주</option>
								<option value="onemonth">최근 1개월</option>
								<option value="onequarter">최근 3개월</option>
								<option value="onehalf">최근 6개월</option>
								<option value="oneyear">최근 1년</option>
							</select>
						</div>
						<div class="col-auto pe-0">
							<div class="input-group">
								<div class="input-group-append">
									<button type="button" id="pdfDownLoad" class="btn btn-primary">PDF 저장</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="pdfArea">
		<div class="card mb-3">
			<div class="card-body text-center py-2">
				<p class="h3 mt-3 fw-normal fs-2 mt-md-4 fs-md-3 initialism">
				<u>데이터 파일 NICE_ASS_20210511.dat 검증 결과</u></p>
			</div>
			<div class="row g-0 justify-content-end">
				<div class="col-auto">
					<table class="table table-sm table-borderless fs--1 text-end">
						<tbody>
							<tr>
								<th class="text-900">실행일자:</th>
								<td class="fw-semi-bold">2021-05-11 01:00:00</td>
							</tr>
							<tr>
								<th class="text-900">프로젝트:</th>
								<td class="fw-semi-bold text-start">NICE_ASS</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;"> 1. 검증결과</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-light">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="verificationChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="fileStateChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;">2. 데이터 항목 일치성</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-light">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="dashItemBar" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="itemMatchChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;">3. 데이터 안정성</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-light">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="psiChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="dataCntChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		var $projectNameItemDropdown = $("#projectNameItemDropdown");
		var $countDropdown = $("#countDropdown");
		var $pdfDownLoad = $("#pdfDownLoad");
		var projectName = "";
		var recentPeriod = "all";

		$(function() {
			fn_projectNames();
			fn_Event();
		});
		

		function fn_Event() {
			$countDropdown.off().on('change', function() {
				recentPeriod = "all";
				fn_data();
			});
			$pdfDownLoad.off().on('click', function() {
			    html2canvas($('#pdfArea')[0] ,{	
			      allowTaint : true,	// cross-origin allow 
			      useCORS: true,		// CORS 사용한 서버로부터 이미지 로드할 것인지 여부
			      scale : 2				// 기본 96dpi에서 해상도를 두 배로 증가
			      
			    }).then(function(canvas) {	
			      // 캔버스를 이미지로 변환
			      var imgData = canvas.toDataURL('image/png');

			      var imgWidth = 190; // 이미지 가로 길이(mm) / A4 기준 210mm
			      var pageHeight = imgWidth * 1.414;  // 출력 페이지 세로 길이 계산 A4 기준
			      var imgHeight = canvas.height * imgWidth / canvas.width;
			      var heightLeft = imgHeight;
			      var margin = 10; // 출력 페이지 여백설정
			      var doc = new jsPDF('p', 'mm');
			      var position = 0;

			      // 첫 페이지 출력
			      doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
			      heightLeft -= pageHeight;

			      // 한 페이지 이상일 경우 루프 돌면서 출력
			      while (heightLeft >= 20) {			// 35
			      position = heightLeft - imgHeight;
			      position = position - 20 ;		// -25

			      doc.addPage();
			      doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
			      heightLeft -= pageHeight;
			      }

			      // 파일 저장
			      doc.save('데이터 검증 보고서.pdf');
			    });
			});
		}
		

		function fn_projectNames() {
			ajaxCall({
				target : "PROJECT_NAMES",
				url : "/result/projectnames/",
				isLoading : false
			});
		}
		

		function fn_data() {
			ajaxCall({
				target : "RECENTDTIM",
				url : "/main/regdtim/" + projectName,
				isLoading : false
			});
		}
		

		function callback(target, data) {
			switch (target) {
			case "PROJECT_NAMES":
				var listName = data;
				var html = "";

				$.each(listName, function(index, data) {
					html += "<option value="+data+">" + data + "</option>";
				});
				$projectNameItemDropdown.append(html);
				$projectNameItemDropdown.off().on(
						'change',
						function() {
							projectName = $(this).val();							
							fn_data();
						});
				$('.picker').select2();
				
				var paramData = jsonParse('[[${paramData}]]');	
				if(!gf_IsNull(paramData)){					
					$projectNameItemDropdown.val(paramData.projectName).trigger('change');
					$countDropdown.val(paramData.recentPeriod).trigger('change');
				}
				
				fn_data();
				break;
				
				
			case "RECENTDTIM":
				$("#recentDtim").html(data[0]);
				ajaxCall({
					target : "ANOMALYCNT",
					url : "/main/anomalycnt/" + projectName + "/" + recentPeriod
				});
				
				ajaxCall({
					target : "STAT",
					url : "/main/stat/" + projectName + "/" + recentPeriod
				});				
				break;
				
				
			case "ANOMALYCNT":				
				var totalData = {"anomalyCnt": 0, "normalCnt": 0};
	              $.each(data, function() {
	                    totalData.anomalyCnt += parseInt(this.anomalyCnt);
	                    totalData.normalCnt += parseInt(this.normalCnt);
	                });
	              
	              var param = {};
	              
	              var data = [{
	            		value : totalData.anomalyCnt,
	            		name : "이상파일"
	            	},{
	            		value : totalData.normalCnt,
	            		name : "정상파일"
	            	}];	
	              
	              var  radius = ['100%', '60%'];
	              
	              param.target = "fileStateChart";
	              param.data = data;
	              param.radius = radius;
	              param.title = "전체 파일 이상감지 결과";
	              param.name = ["정상파일", "이상파일"];
	              param.color = [utils.getColors().danger, utils.getColors().primary];
	              fn_PieChart(param);				
	              
	              
	              ///////////////////////////    임시	    /////////////////////////         
	               var data2 = [{
	            		value : 1,
	            		name : "안정성"
	            	},{
	            		value : 1,
	            		name : "항목별"
	            	}
	            	];	
	              
	              var  radius = ['100%', '0%'];
	              param.target = "verificationChart";
	              param.data = data2;
	              param.radius = radius;
	              param.title = "검증 결과";
	              param.name = [ "항목별","안정성"];
	              param.color = [utils.getColors().success,utils.getColors().danger];
	              fn_PieChart(param);
	              
	              
	              fn_HorizontalBarChart()
				  ///////////////////////////    임시	    ///////////////////////// 
				  
				break;
				
				
			case "STAT":
				var statData = {
					"dtims" : [],
					"psis" : [],
					"cars" : [],
					"chisqcnts" : [],
					"datacnts" : []
				};
				$.each(data, function() {
					statData.dtims.push(this.dtim);
					statData.psis.push(parseFloat(this.psi));
					statData.cars.push(parseInt(this.car));
					//statData.chisqcnts.push(parseInt(this.chisqcnt));
					statData.datacnts.push(parseInt(this.inputDataCnt));
				});
				fn_LineChart(statData); // 분포 안정 지표

				// 데이터 수 
				var param = {
					target : "dataCntChart",
					title : "데이터 수",
					xData : statData.dtims,
					yData : statData.datacnts,
					name : "건수",
					barColor : utils.getColors().primary,

				}
				fn_BarChart(param)

				// 일별 이상항목수 
				param.target = "dashItemBar";
				param.title = "일별 이상 항목 수";
				param.xData = statData.dtims;
				param.yData = statData.cars;
				param.name = "항목수";
				param.barColor = utils.getColors().danger
				fn_BarChart(param)

				// 분포 이상 항목수				
				/* param.target = "dashChisqBar";
				param.title = "분포 이상 항목수";
				param.xData = statData.dtims;
				param.yData = statData.chisqcnts;
				param.barColor = utils.getColors().primary;
				fn_BarChart(param); */
				break;
				
				
			default:
				break;
			}
		}
		
		
		var fn_PieChart = function (param) {
			if (pieChart != null) {
				pieChart.destroy();
			}
			
			var pieChart = document.getElementById(param.target);
			var myChart = echarts.init(pieChart);
			var option;

			option = {
				title : {
					text : param.title,
					show : true
				},
				color: param.color,
				tooltip: {
			          trigger: 'item',
			          padding: [7, 10],
			          backgroundColor: utils.getGrays()['100'],
			          borderColor: utils.getGrays()['300'],
			          textStyle: {
			            color: utils.getColors().dark
			          },
			          borderWidth: 1,
			          transitionDuration: 0,
			          formatter: function formatter(params) {
			              return "<strong>".concat(params.data.name, ":</strong> ").concat(params.value, "건");
			            }
			        },
		        position: function position(pos, params, dom, rect, size) {
		            return getPosition(pos, params, dom, rect, size);
		          },

				legend : {
					data : param.name,
					bottom: 0,
				    left: 'right',
					itemWidth : 10,
					itemHeight : 10,
					borderRadius : 0,
					icon : 'circle',
					inactiveColor : utils.getGrays()['400'],
					textStyle : {
						color : utils.getGrays()['700']
					}
				},

				toolbox : {
					feature : {
						saveAsImage : {
							title : 'Save As'
						}
					}
				},
				
				series: [{
			          type: 'pie',
			          radius: param.radius,
			          avoidLabelOverlap: false,
			          hoverAnimation: false,
			          itemStyle: {
			            borderWidth: 2,
			            borderColor: utils.getColor('card-bg')
			          },
			          label: {
			            normal: {
			              show: false,
			              position: 'center',
			              textStyle: {
			                fontSize: '20',
			                fontWeight: '500',
			                color: utils.getGrays()['700']
			              }
			            },
			            emphasis: {
			              show: false
			            }
			          },
			          labelLine: {
			            normal: {
			              show: false
			            }
			          },
			          data: param.data
			        }]
			};

			option && myChart.setOption(option);
	    }		
		

		function fn_LineChart(data) {
			if (psiLineChart != null) {
				psiLineChart.destroy();
			}

			var dataSize = data.dtims.length
			var thresholdValue = 1.0;
			var thresholdArray = new Array(dataSize);
			for (var i = 0; i < dataSize; i++) {
				thresholdArray[i] = thresholdValue;
			}

			var psiLineChart = document.getElementById('psiChart');
			var myChart = echarts.init(psiLineChart);
			var option;

			option = {
				title : {
					text : '분포 안정 지표',
					show : true
				},
				color : [ utils.getColors().primary, utils.getColors().danger ],
				tooltip : {
					trigger : 'axis',
					padding : [ 7, 10 ],
					backgroundColor : utils.getGrays()['100'],
					borderColor : utils.getGrays()['300'],
					textStyle : {
						color : utils.getColors().dark
					},
					borderWidth : 1,
					transitionDuration : 0,
					position : function position(pos, params, dom, rect, size) {
						return getPosition(pos, params, dom, rect, size);
					}
				},

				legend : {
					data : [ 'PSI', 'Threshold' ],
					left : 'center',
					itemWidth : 10,
					itemHeight : 10,
					borderRadius : 0,
					icon : 'circle',
					inactiveColor : utils.getGrays()['400'],
					textStyle : {
						color : utils.getGrays()['700']
					}
				},

				toolbox : {
					feature : {
						saveAsImage : {
							title : 'Save As'
						}
					}
				},
				xAxis : {
					type : 'category',
					data : data.dtims,
					boundaryGap : false,
					axisPointer : {
						lineStyle : {
							color : utils.getGrays()['300'],
							type : 'dashed'
						}
					},
					splitLine : {
						show : false
					},
					axisLine : {
						lineStyle : {
							color : utils.rgbaColor('#000', 0.01),
							type : 'dashed'
						}
					},
					axisTick : {
						show : false
					},
					axisLabel : {
						color : utils.getGrays()['400'],
						margin : 15,
						rotate : 45,
						textStyle : {
							fontSize : 10
						}
					}
				},
				yAxis : {
					type : 'value',
					axisPointer : {
						show : false
					},
					splitLine : {
						lineStyle : {
							color : utils.getGrays()['300'],
							type : 'dashed'
						}
					},
					boundaryGap : false,
					axisLabel : {
						show : true,
						color : utils.getGrays()['400'],
						margin : 15,
						textStyle : {
							fontSize : 10
						}
					},
					axisTick : {
						show : false
					},
					axisLine : {
						show : false
					}
				},
				series : [
						{
							name : 'PSI',
							type : 'line',
							data : data.psis,
							lineStyle : {
								color : utils.getColors().primary
							},
							itemStyle : {
								borderColor : utils.getColors().primary,
								borderWidth : 2
							},
							showSymbol : false,
							smooth : true,
							hoverAnimation : true,
							areaStyle : {
								color : {
									type : 'linear',
									x : 0,
									y : 0,
									x2 : 0,
									y2 : 1,
									colorStops : [
											{
												offset : 0,
												color : utils.rgbaColor(utils
														.getColors().primary,
														0.2)
											},
											{
												offset : 1,
												color : utils
														.rgbaColor(
																utils
																		.getColors().primary,
																0)
											} ]
								}
							}
						}, {
							name : 'Threshold',
							type : 'line',
							data : thresholdArray,
							lineStyle : {
								color : utils.getColors().danger
							},
							itemStyle : {
								borderColor : utils.getColors().danger,
								borderWidth : 2
							},
							showSymbol : false,
							smooth : false,
							hoverAnimation : true
						}

				]
			};

			option && myChart.setOption(option);
		}
		

		function fn_BarChart(param) {

			if (itemBarChart != null) {
				itemBarChart.destroy();
			}

			var itemBarChart = document.getElementById(param.target);
			var myChart = echarts.init(itemBarChart);
			var option;

			option = {
				title : {
					text : param.title,
					show : true
				},
				color : [ utils.getColors().primary ],
				tooltip : {
					trigger : 'item',
					padding : [ 7, 10 ],
					backgroundColor : utils.getGrays()['100'],
					borderColor : utils.getGrays()['300'],
					textStyle : {
						color : utils.getColors().dark
					},
					borderWidth : 1,
					transitionDuration : 0,
					position : function position(pos, params, dom, rect, size) {
						return getPosition(pos, params, dom, rect, size);
					}
				},

				legend : {
					data : [ param.name ],
					left : 'center',
					itemWidth : 10,
					itemHeight : 10,
					borderRadius : 0,
					icon : 'circle',
					inactiveColor : utils.getGrays()['400'],
					textStyle : {
						color : utils.getGrays()['700']
					}
				},
				toolbox : {
					feature : {
						saveAsImage : {
							title : 'Save As'
						}
					}
				},
				xAxis : {
					type : 'category',
					data : param.xData,
					axisLabel : {
						color : utils.getGrays()['400'],
						rotate : 45,
						textStyle : {
							fontSize : 10
						}
					},
					axisLine : {
						lineStyle : {
							color : utils.getGrays()['300'],
							type : 'dashed'
						}
					},
					axisTick : false,
					boundaryGap : true

				},
				yAxis : {
					axisPointer : {
						type : 'none'
					},
					axisTick : 'none',
					splitLine : {
						lineStyle : {
							color : utils.getGrays()['300'],
							type : 'dashed'
						}
					},
					axisLine : {
						show : false
					},
					axisLabel : {
						color : utils.getGrays()['400'],
						rotate : 45,
						textStyle : {
							fontSize : 10
						}
					}
				},
				series : [ {
					name : param.name,
					type : 'bar',
					data : param.yData,
					type : 'bar',
					barWidth : '12%',
					barGap : '30%',
					label : {
						normal : {
							show : false
						}
					},
					z : 10,
					itemStyle : {
						normal : {
							barBorderRadius : [ 10, 10, 0, 0 ],
							color : param.barColor
						}
					}
				}, {
					type : 'bar',
					barWidth : '12%',
					barGap : '30%',
					label : {
						normal : {
							show : false
						}
					},
					itemStyle : {
						normal : {
							barBorderRadius : [ 4, 4, 0, 0 ],
							color : utils.getGrays()[300]
						}
					}
				} ],
			};

			option && myChart.setOption(option);
		}
		
		
		
		//항목별 일치성 예제
		function fn_HorizontalBarChart() {
			
			var data = [10, 20, 30, 40, 50, 90];
			var dataArray = []
			
			$.each(data, function(i) {				
				var dataObj ={}				
				if (this > 80){
					dataObj.value = data[i];
					dataObj.itemStyle = {color: utils.getColors().danger};
				}else{
					dataObj.value = data[i];
					dataObj.itemStyle = {color: utils.getColors().primary};
				}
				
				dataArray.push(dataObj);
			});

			
			if (itemMatchChart != null) {
				itemMatchChart.destroy();
			}
			
			var itemMatchChart = document.getElementById('itemMatchChart');
			var myChart = echarts.init(itemMatchChart);
			var option;
			
			option = {
					title: {
				        text: '항목별 일치성',
				        show: true
				    },
				    color : [ utils.getColors().primary ],
				    tooltip : {
						trigger : 'item',
						padding : [ 7, 10 ],
						backgroundColor : utils.getGrays()['100'],
						borderColor : utils.getGrays()['300'],
						textStyle : {
							color : utils.getColors().dark
						},
						borderWidth : 1,
						transitionDuration : 0 ,
						formatter: function formatter(params) {
				              return "<strong>".concat(params.name, ":</strong> ").concat(params.value, "%");
			            }
					},
										
					legend : {
						left : 'center',
						itemWidth : 10,
						itemHeight : 10,
						borderRadius : 0,
						icon : 'circle',
						inactiveColor : utils.getGrays()['400'],
						textStyle : {
							color : utils.getGrays()['700']
						}
					},
					toolbox : {
						feature : {
							saveAsImage : {
								title : 'Save As'
							}
						}
					},
				    grid: {
				        left: '3%',
				        right: '4%',
				        bottom: '3%',
				        containLabel: true
				    },
				    xAxis: {
				        type: 'value',
				        axisTick : false,
				        axisLabel : {
							color : utils.getGrays()['400'],
							textStyle : {
								fontSize : 10
							}
						},
						boundaryGap : true
				    },
				    yAxis: {
				        type: 'category',
						axisLabel : {
							color : utils.getGrays()['400'],
							textStyle : {
								fontSize : 10
							}
						},
				        data: ['A00001', 'A00002', 'A00003', 'A00004', 'A00005', 'A00006']
				    },
				    series: [
				       
				        {
							type : 'bar',
							data: dataArray,
							barWidth : '60%',
							barGap : '30%',
							label : {
								normal : {
									show : true
								}
							},
							z : 10
				        }
				    ],
			};

			option && myChart.setOption(option);
		}
	</script>
</div>
</html>