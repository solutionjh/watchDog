<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate ="~{layout/default}">	
<head>
<title>[[#{left.012}]]</title>
</head>
	<div layout:fragment="content">
	<div class="card mb-3">
		<div class="bg-holder d-none d-lg-block bg-card"
			style="background-image: url(/assets/img/illustrations/corner-4.png);">
		</div>
		<div class="card-header pb-1">			
		</div>
		<div class="card-body pt-0">
			<div class="row flex-between-center">
                <div class="col-sm-auto mb-2 mb-sm-0">
					<h4 class="mb-0 title-area" data-anchor="data-anchor" id="tooltips">[[#{left.012}]]</h4>					
				</div>
			
				<div class="col-sm-auto">
					<div class="row gx-2 align-items-center">
						<div class="col-auto">
							<select id="projectNameItemDropdown" class="form-select picker"
								data-live-search="true">
								<option value="">[[#{select.project.select}]]</option>
							</select>
						</div>
						<div class="col-auto">
							<select id="regdtimDropdown" class="form-select picker"
								data-live-search="true">
								<option value="">[[#{select.perform.select}]]</option>
							</select>
						</div>
						<div class="col-auto pe-0">							
							<div
								class="topBtnDiv col-6 col-sm-auto ml-auto text-right pl-0 input-group">
								<button id="pdfDownLoad" data-id="onlineNew"
									class="btn btn-falcon-default btn-sm"  type="button">[[#{button.pdf.save}]]
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="pdfArea">
		<div class="card mb-3">
			<div class="card-body text-center py-2">
				<p class="h3 mt-3 fw-normal fs-2 mt-md-4 fs-md-3 initialism">
				<u id="title"></u></p>
			</div>
			<div class="row g-0 justify-content-end">
				<div class="col-auto">
					<table class="table table-sm table-borderless fs--1 text-end">
						<tbody>
							<tr>
								<th class="text-900">[[#{txt.execution.date}]] :</th>
								<td class="fw-semi-bold recentDtim"></td>
							</tr>
							<tr>
								<th class="text-900">[[#{txt.project}]] :</th>
								<td class="fw-semi-bold text-start" id="project-name"></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;"> 1. [[#{txt.verification.res}]]</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-200">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body  indicator">
										<div class="tab-content" style="height: 250px;">
											<div style="min-height: 250px; display:none;"  id="item-safe-area">
												<div class="indicator-title">[[#{txt.item.safety.res }]]</div>
												<div class="d-flex justify-content-center  mb-2 ">
													<img src="" class="indicator-img left" id="indicator-img-left" >	
													<span class="indicator-span left">[[#{txt.item}]]</span>
												
													<img src="" class="indicator-img right" id="indicator-img-right" >	
													<span class="indicator-span right">[[#{txt.safety}]]</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body ">
										<div class="tab-content" style="height: 250px;">
											<div id="fileStateChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;">2. [[#{txt.data.same}]]</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-200">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body ">
										<div class="tab-content" style="height: 250px;">
											<div id="dashItemBar" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body ">
										<div class="tab-content" style="height: 250px;">
											<div id="itemMatchChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;">3. [[#{txt.data.safety}]]</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-200">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body ">
										<div class="tab-content" style="height: 250px;">
											<div id="psiChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body ">
										<div class="tab-content" style="height: 250px;">
											<div id="dataCntChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	     
	<script type="text/javascript">
		var $projectNameItemDropdown = $("#projectNameItemDropdown");
		var $regdtItemDropdown = $("#regdtimDropdown");
		var $pdfDownLoad = $("#pdfDownLoad");
		var projectName = "";
		var paramData = {};
		$(function() {			
			paramData = jsonParse('[[${paramData}]]');	

			fn_projectNames();
			fn_Event();
		});
		

		function fn_Event() {
			$pdfDownLoad.off().on('click', function() {
			    html2canvas($('#pdfArea')[0] ,{	
			      allowTaint : true,	// cross-origin allow 
			      useCORS: true,		// CORS 사용한 서버로부터 이미지 로드할 것인지 여부
			      scale : 2				// 기본 96dpi에서 해상도를 두 배로 증가
			      
			    }).then(function(canvas) {	
			      // 캔버스를 이미지로 변환
			      var imgData = canvas.toDataURL('image/png');

			      var imgWidth = 190; // 이미지 가로 길이(mm) / A4 기준 210mm
			      var pageHeight = imgWidth * 1.414;  // 출력 페이지 세로 길이 계산 A4 기준
			      var imgHeight = canvas.height * imgWidth / canvas.width;
			      var heightLeft = imgHeight;
			      var margin = 10; // 출력 페이지 여백설정
			      var doc = new jsPDF('p', 'mm');
			      var position = 0;

			      // 첫 페이지 출력
			      doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
			      heightLeft -= pageHeight;

			      // 한 페이지 이상일 경우 루프 돌면서 출력
			      while (heightLeft >= 20) {			// 35
			      position = heightLeft - imgHeight;
			      position = position - 20 ;		// -25

			      doc.addPage();
			      doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
			      heightLeft -= pageHeight;
			      }

			      // 파일 저장
			      doc.save('[[#{txt.verification.report.pdf}]]');
			    });
			});
		}
		

		function fn_projectNames() {
			ajaxCall({
				target : "PROJECT_NAMES",
				url : "/result/projectnames/",
				isLoading : false
			});
		}
		

		function fn_data() {			
			if(projectName && $regdtItemDropdown.val()){				
				ajaxCall({
					target : "RECENTDTIM",
					url : "/main/regdtim/" + projectName,
					isLoading : false
				});
			}
			
		}
		
		function fn_regdtItems(projectName) {		
			if (projectName) {
				ajaxCall(param = {
					target : "REGDT_ITEMS",
					url : "/resultitemdist/" + projectName + "/regdtim/",
					isLoading : false
				});
				
			} else {
				$regdtItemDropdown.find("option").remove();
				$regdtItemDropdown
						.append("<option value=''>[[#{select.perform.select}]]</option>");
				
				$("#title, .recentDtim").html("");
				$("#item-safe-area , #fileStateChart ,#dataCntChart ,#psiChart , #itemMatchChart , #dashItemBar").hide();	
			}
		}
		
		function callback(target, data) {
			switch (target) {
			case "PROJECT_NAMES":
				var listName = data;
				var html = "";

				$.each(listName, function(index, data) {
					html += "<option value="+data+">" + data + "</option>";
				});
				$projectNameItemDropdown.append(html);
				$projectNameItemDropdown.off().on(
						'change',
						function() {
							projectName = $(this).val();		
							$("#project-name").html($(this).val());
							fn_regdtItems($(this).val());							
						});
				$('.picker').select2();
				
				if(!gf_IsNull(paramData)){					
					$projectNameItemDropdown.val(paramData.projectName).trigger('change');
					$("#project-name").html(paramData.projectName);
				}
				
				fn_data();
				break;
				
				
			case "RECENTDTIM":
				console.log(data)
				$(".recentDtim").html(data[0]);
								
				var dtim = $regdtItemDropdown.val(); 
				var projectNameParam = projectName == "" ? "": "/" + projectName
				
				
				ajaxCall({
					target : "ANOMALYCNT",
					url : "/main/anomalycnt/7/" + dtim + projectNameParam
				});
				
				ajaxCall({
					target : "STAT",
					url : "/main/stat/7/" + dtim + projectNameParam
				});		
				//파일명 응답
				ajaxCall({
					target : "FILENAME",
					url : "/result/filename/" + projectName +"/"+ dtim
				});			
				
				//보고서 안정성지표 응답
				ajaxCall({
					target : "ANOMALYINDEX",
					url : "/result/anomalyindex/" + projectName +"/"+ dtim
				});				
				
				//보고서 항목별일치성 응답
				ajaxCall({
					target : "ITEMANOMALY",
					url : "/result/itemanomaly/" + projectName +"/"+ dtim
				});				
				
				
				$("#item-safe-area , #fileStateChart ,#dataCntChart ,#psiChart , #itemMatchChart , #dashItemBar").show();	
				break;
				
				
			case "ANOMALYCNT":				
				var totalData = {"anomalyCnt": 0, "normalCnt": 0};
	              $.each(data, function() {
	                    totalData.anomalyCnt += parseInt(this.anomalyCnt);
	                    totalData.normalCnt += parseInt(this.normalCnt);
	                });
	              
	              var param = {};
	              
	              var data = [{
	            		value : totalData.anomalyCnt,
	            		name : '[[#{txt.anormal.file}]]'
	            	},{
	            		value : totalData.normalCnt,
	            		name : '[[#{txt.normal.file}]]'
	            	}];	
	              
	              var  radius = ['85%', '60%'];
	              
	              param.target = "fileStateChart";
	              param.data = data;
	              param.radius = radius;
	              param.title = '[[#{txt.file.anormal.detection}]]';
	              param.name = ['[[#{txt.normal.file}]]', '[[#{txt.anormal.file}]]'];
	              param.formatterTxt ='[[#{txt.number}]]';	
	              fn_PieChart(param);								  
				break;
				
				
			case "STAT":
				var statData = {
					"dtims" : [],
					"psis" : [],
					"cars" : [],
					"chisqcnts" : [],
					"datacnts" : []
				};
				$.each(data, function() {
					statData.dtims.push(this.dtim);
					statData.psis.push(parseFloat(this.psi));
					statData.cars.push(parseInt(this.car));
					//statData.chisqcnts.push(parseInt(this.chisqcnt));
					statData.datacnts.push(parseInt(this.inputDataCnt));
				});
				
				statData.title ='[[#{txt.distribution.stability.indicator}]]';								
				fn_PsiChart(statData); // 분포 안정 지표

				// 데이터 수 
				var param = {
					target : "dataCntChart",
					title : '[[#{txt.data.count}]]',					
					xData : statData.dtims,
					yData : statData.datacnts,
					name : '[[#{txt.number.count}]]'

				}
				fn_LineChart(param)

				// 일별 이상항목수 
				param.target = "dashItemBar";
				param.title = '[[#{txt.anomaly.count}]]';
				param.xData = statData.dtims;
				param.yData = statData.cars;
				param.name = '[[#{txt.item.count}]]';
				fn_BarChart(param)

				// 분포 이상 항목수				
			 /* param.target = "dashChisqBar";
				param.title = "분포 이상 항목수";
				param.xData = statData.dtims;
				param.yData = statData.chisqcnts;
				fn_BarChart(param); */
				break;
			case "FILENAME":	
				$("#title").html(data[0]);
				break;
			case "ANOMALYINDEX":	
				if(data.ITEMINDEX == 0){
					$("#indicator-img-left").attr('src', '/assets/img/nice/on.png')
				}else{
					$("#indicator-img-left").attr('src', '/assets/img/nice/off.png')
				}
				if(data.ITEMINDEX == 0){
					$("#indicator-img-right").attr('src', '/assets/img/nice/on.png')
				}else{
					$("#indicator-img-right").attr('src', '/assets/img/nice/off.png')
				}
					
				
				break;
			case "ITEMANOMALY":	
				var dataArray = [];
				var nameArray = [];
				var stateArray = [];
				$.each(data,function(){
					nameArray.push(this.fieldName)
					dataArray.push(this.itemAnomalyLevel)
					stateArray.push(this.isAnomaly)
				});
				 var param = {};
	              param.title = '[[#{txt.item.same}]]';
	              param.data = dataArray;
	              param.name = nameArray;
	              param.state = stateArray;
	              
	              fn_HorizontalBarChart(param);
		
				break;				
			case "REGDT_ITEMS":
				$regdtItemDropdown.find("option").remove();
				var html = "<option value=''>[[#{select.perform.select}]]</option>";

				$.each(data, function(index, data) {
					html += '<option value="'+data+'">' + data + '</option>';
				});
				$regdtItemDropdown.append(html);

				$regdtItemDropdown.off().change(function() {
					fn_data();
				});
				$('.picker').select2();
									
				if(!gf_IsNull(paramData)){			
					$regdtItemDropdown.val(paramData.recentDtim).trigger('change');
				}
				break;	
				
				
			default:
				break;
			}
		}
	</script>
</div>
</html>