<!DOCTYPE html>

<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate ="~{layout/default}">	
<head>
<title>[[#{left.012}]]</title>
</head>
	<div layout:fragment="content">
	<div class="card mb-3">
		<div class="bg-holder d-none d-lg-block bg-card"
			style="background-image: url(/assets/img/illustrations/corner-4.png);">
		</div>
		<div class="card-header pb-1">
			<div class="row flex-between-end">
				<div class="col-auto col-lg align-self-center">
                  <h4 class="mb-0 title-area" data-anchor="data-anchor" id="tooltips">[[#{left.012}]]</h4>
                </div>
			</div>
		</div>
		<div class="card-body pt-0">
			<div class="row flex-between-center">
				<div class="col-sm-auto mb-2 mb-sm-0">
					<h6 class="mb-0">[[#{txt.recent.time}]]<span class="text-500 recentDtim" ></span></h6>
				</div>
				<div class="col-sm-auto">
					<div class="row gx-2 align-items-center">
						<div class="col-auto">
							<select id="projectNameItemDropdown" class="form-select picker"
								data-live-search="true">
								<option value="">[[#{select.project.select}]]</option>
							</select>
						</div>
						<div class="col-auto">
							<!-- <select id="countDropdown" class="form-select picker"
								data-live-search="true">
								<option value="">[[#{select.perform.select}]]</option>
								<option value="7">[[#{select.perform.select.001}]]</option>
								<option value="15">[[#{select.perform.select.001}]]</option>
								<option value="30">[[#{select.perform.select.001}]]</option>

								<option value="all">[[#{select.perform.select}]]</option>
								<option value="oneday">[[#{select.perform.select.001}]]</option>
								<option value="oneweek">[[#{select.perform.select.002}]]</option>
								<option value="onemonth">[[#{select.perform.select.003}]]</option>
								<option value="onequarter">[[#{select.perform.select.004}]]</option>
								<option value="onehalf">[[#{select.perform.select.005}]]</option>
								<option value="oneyear">[[#{select.perform.select.006}]]</option>
							</select> -->
						</div>
						<div class="col-auto pe-0">
							<div class="input-group">
								<div class="input-group-append">
									<input class="form-control datetimepicker" id="start-date"
										type="text" placeholder="d/m/y"
										data-options='{"dateFormat":"d/m/y","disableMobile":true}' />
								</div>
							</div>
						</div>
						<div class="col-auto pe-0">
							<div class="input-group">
								<div class="input-group-append">
									<input class="form-control datetimepicker" id="start-time"
										type="text" placeholder="H:i"
										data-options='{"enableTime":true,"noCalendar":true,"dateFormat":"H:i","disableMobile":true}' />

								</div>
							</div>
						</div>
						<div class="col-auto pe-0">
							<div class="input-group">
								<div class="input-group-append">
									<button type="button" id="pdfDownLoad" class="btn btn-primary">[[#{button.pdf.save}]]</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="pdfArea">
		<div class="card mb-3">
			<div class="card-body text-center py-2">
				<p class="h3 mt-3 fw-normal fs-2 mt-md-4 fs-md-3 initialism">
				<u>데이터 파일 NICE_ASS_20210511.dat 검증 결과</u></p>
			</div>
			<div class="row g-0 justify-content-end">
				<div class="col-auto">
					<table class="table table-sm table-borderless fs--1 text-end">
						<tbody>
							<tr>
								<th class="text-900">[[#{txt.execution.date}]] :</th>
								<td class="fw-semi-bold recentDtim"></td>
							</tr>
							<tr>
								<th class="text-900">[[#{txt.project}]] :</th>
								<td class="fw-semi-bold text-start" id="project-name"></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;"> 1. [[#{txt.verification.res}]]</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-light">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="verificationChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="fileStateChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;">2. [[#{txt.data.same}]]</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-light">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="dashItemBar" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="itemMatchChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row g-3 mb-3">
			<div class="col-lg-12">
				<div class="card">
					<div class="card-header">
						<div class="row flex-between-end">
							<div class="col-auto col-lg align-self-center">
								<h5 class="mb-0" data-anchor="data-anchor" id="bar-chart">
									<a class="anchorjs-link " aria-label="Anchor"
										data-anchorjs-icon="#" href="#bar-chart"
										style="padding-left: 0.375em;">3. [[#{txt.data.safety}]]</a>
								</h5>
							</div>
						</div>
					</div>
					<div class="card-body bg-light">
						<div class="row g-3 mb-3">
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="psiChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
							<div class="col-lg-6">
								<div class="card">
									<div class="card-body bg-light">
										<div class="tab-content">
											<div id="dataCntChart" style="min-height: 250px;"></div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	 <script src="/assets/js/flatpickr.js"></script>         
	<script type="text/javascript">
		var $projectNameItemDropdown = $("#projectNameItemDropdown");
		var $countDropdown = $("#countDropdown");
		var $pdfDownLoad = $("#pdfDownLoad");
		var projectName = "";
		var recentPeriod = "all";

		$(function() {
			fn_projectNames();
			fn_Event();
		});
		

		function fn_Event() {
			$countDropdown.off().on('change', function() {
				recentPeriod = "all";
				fn_data();
			});
			$pdfDownLoad.off().on('click', function() {
			    html2canvas($('#pdfArea')[0] ,{	
			      allowTaint : true,	// cross-origin allow 
			      useCORS: true,		// CORS 사용한 서버로부터 이미지 로드할 것인지 여부
			      scale : 2				// 기본 96dpi에서 해상도를 두 배로 증가
			      
			    }).then(function(canvas) {	
			      // 캔버스를 이미지로 변환
			      var imgData = canvas.toDataURL('image/png');

			      var imgWidth = 190; // 이미지 가로 길이(mm) / A4 기준 210mm
			      var pageHeight = imgWidth * 1.414;  // 출력 페이지 세로 길이 계산 A4 기준
			      var imgHeight = canvas.height * imgWidth / canvas.width;
			      var heightLeft = imgHeight;
			      var margin = 10; // 출력 페이지 여백설정
			      var doc = new jsPDF('p', 'mm');
			      var position = 0;

			      // 첫 페이지 출력
			      doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
			      heightLeft -= pageHeight;

			      // 한 페이지 이상일 경우 루프 돌면서 출력
			      while (heightLeft >= 20) {			// 35
			      position = heightLeft - imgHeight;
			      position = position - 20 ;		// -25

			      doc.addPage();
			      doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
			      heightLeft -= pageHeight;
			      }

			      // 파일 저장
			      doc.save('[[#{txt.verification.report.pdf}]]');
			    });
			});
		}
		

		function fn_projectNames() {
			ajaxCall({
				target : "PROJECT_NAMES",
				url : "/result/projectnames/",
				isLoading : false
			});
		}
		

		function fn_data() {
			ajaxCall({
				target : "RECENTDTIM",
				url : "/main/regdtim/" + projectName,
				isLoading : false
			});
		}
		

		function callback(target, data) {
			switch (target) {
			case "PROJECT_NAMES":
				var listName = data;
				var html = "";

				$.each(listName, function(index, data) {
					html += "<option value="+data+">" + data + "</option>";
				});
				$projectNameItemDropdown.append(html);
				$projectNameItemDropdown.off().on(
						'change',
						function() {
							projectName = $(this).val();		
							$("#project-name").html($(this).val());
							fn_data();
						});
				$('.picker').select2();
				
				var paramData = jsonParse('[[${paramData}]]');	
				if(!gf_IsNull(paramData)){					
					$projectNameItemDropdown.val(paramData.projectName).trigger('change');
					$countDropdown.val(paramData.recentPeriod).trigger('change');
					$("#project-name").html(paramData.projectName);
				}
				
				fn_data();
				break;
				
				
			case "RECENTDTIM":
				$(".recentDtim").html(data[0]);
				ajaxCall({
					target : "ANOMALYCNT",
					url : "/main/anomalycnt/" + projectName + "/" + recentPeriod
				});
				
				ajaxCall({
					target : "STAT",
					url : "/main/stat/" + projectName + "/" + recentPeriod
				});				
				break;
				
				
			case "ANOMALYCNT":				
				var totalData = {"anomalyCnt": 0, "normalCnt": 0};
	              $.each(data, function() {
	                    totalData.anomalyCnt += parseInt(this.anomalyCnt);
	                    totalData.normalCnt += parseInt(this.normalCnt);
	                });
	              
	              var param = {};
	              
	              var data = [{
	            		value : totalData.anomalyCnt,
	            		name : '[[#{txt.anormal.file}]]'
	            	},{
	            		value : totalData.normalCnt,
	            		name : '[[#{txt.normal.file}]]'
	            	}];	
	              
	              var  radius = ['100%', '60%'];
	              
	              param.target = "fileStateChart";
	              param.data = data;
	              param.radius = radius;
	              param.title = '[[#{txt.file.anormal.detection}]]';
	              param.name = ['[[#{txt.normal.file}]]', '[[#{txt.anormal.file}]]'];
	              param.color = [utils.getColors().danger, utils.getColors().primary];
	              fn_PieChart(param);				
	              
	              
	              ///////////////////////////    임시	    /////////////////////////         
	               var data2 = [{
	            		value : 1,
	            		name : '[[#{txt.safety}]]'
	            	},{
	            		value : 1,
	            		name : '[[#{txt.item}]]'
	            	}
	            	];	
	              
	              var  radius = ['100%', '0%'];
	              param.target = "verificationChart";
	              param.data = data2;
	              param.radius = radius;
	              param.title = '[[#{txt.distribution.stability.indicator}]]';
	              param.name = [ '[[#{txt.item}]]','[[#{txt.safety}]]'];
	              param.color = [utils.getColors().success,utils.getColors().danger];
	              fn_PieChart(param);
	              
	              
	              fn_HorizontalBarChart()
				  ///////////////////////////    임시	    ///////////////////////// 
				  
				break;
				
				
			case "STAT":
				var statData = {
					"dtims" : [],
					"psis" : [],
					"cars" : [],
					"chisqcnts" : [],
					"datacnts" : []
				};
				$.each(data, function() {
					statData.dtims.push(this.dtim);
					statData.psis.push(parseFloat(this.psi));
					statData.cars.push(parseInt(this.car));
					//statData.chisqcnts.push(parseInt(this.chisqcnt));
					statData.datacnts.push(parseInt(this.inputDataCnt));
				});
				fn_PsiChart(statData); // 분포 안정 지표

				// 데이터 수 
				var param = {
					target : "dataCntChart",
					title : '[[#{txt.data.count}]]',
					xData : statData.dtims,
					yData : statData.datacnts,
					name : '[[#{txt.number.count}]]',
					barColor : utils.getColors().primary,

				}
				fn_LineChart(param)

				// 일별 이상항목수 
				param.target = "dashItemBar";
				param.title = '[[#{txt.anomaly.count}]]';
				param.xData = statData.dtims;
				param.yData = statData.cars;
				param.name = '[[#{txt.item.count}]]';
				param.barColor = utils.getColors().danger
				fn_BarChart(param)

				// 분포 이상 항목수				
				/* param.target = "dashChisqBar";
				param.title = "분포 이상 항목수";
				param.xData = statData.dtims;
				param.yData = statData.chisqcnts;
				param.barColor = utils.getColors().primary;
				fn_BarChart(param); */
				break;
				
				
			default:
				break;
			}
		}
	</script>
</div>
</html>